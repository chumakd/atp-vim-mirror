#
# Author: Marcin Szamotulski
# This is a to do list for ATP vim plugin.
# I put here notes on planned features, 
# but also I use this file for bugs that I found.

pedit for openning without changing the window number! 

ToDo: add support for plain TeX users in the function atplib#SearchPackage()
	in TeX one writes: '\input tikz.tex' instead of '\usepackage{tikz}'
	in while in ConTeXt '\usemodule[tikz]'

ToDo: Pattern not found should restore the window position
ToDo: :2match (and :3match)  in HighlightMatchingPair and Search function - it
is better to use matchadd().

ToDo: Disable mapping # before \ (make an IMAP function)

    "THIS MIGHT BE USEFULL:
    The first column is 1.	0 is returned for an error.
    A more advanced example that echoes the maximum length of
    all lines:
    echo max(map(range(1, line('$')), "virtcol([v:val, '$'])"))

MakeLatex	    
	MakeLatex, Delete -> puts MakeLatex in an endless loop.

TODO: make toc work with parts!
 		The work has started ...

TODO: Check against lilypond 

<Ctrl-W>k<Ctrl-W>_		Fast switching bettween buffers				

<HARD>
Make a function which reads the log file and sets error list.	
It is quite hard to make efm so that it gets error messages with file name.
Possible solution is to write w program/function to rewrite the log message.

In 'plaintex' MakeLatex results in an infinte loop. 

:S /{pattern}/ is not working in plain tex files.

To do: add large delimiters to completion (Bracket closings: Table 3.9 in
    lshort pdfpage: 80) but also \lceil:\rceil, \lfloor:\rfloor, \vert:\vert,
    \Vert:\Vert (make this fast, count all $,\vert,\Vert at once)
To do: completion: make the screen stable.

To do: Make an if statement: write if the history is nonempty!
#To do: \left\.:\right pair! (let the user write the closing bracket.
	also \lvert:\rvert, \lVert:\rVert (only in amsmath)

To do: Show History (at least the variables which are short)
 
To do: Make Todo for project files.

To doc: compare double empty lines, compare spaces.
To do: test SyncXpdf when syncing the last page (boarder conditions).
	It doesn't work as it should - this is a minor bug.

NOTE: in aux file definitions are resolved (see \av)


To do: :R Replace like :S  (project files). /there might be vim way to do that/.

Bug:  BibSearch /Brzeznski/ shows articles of Pflaum! (Mat.bib).
Because he is in:
    MRCLASS   
    MRNUMBER  
    MRREVIEWER
The problem is that All flag doesn't show this entries.  


Todo: Write searchpair function for log file which ignores bracketes in
Overfull message (it happens that these brackets doesn't come in pairs!).

Todo: SetProjectName should test project scripts, I think LoadProject has this code!
	There are two function to implement this: FindProjectScripts() and GetProjectScript()
 
Todo: :S could be much faster using ijump.
Todo: TexSyntaxMotion is not working on last H of: \mbox{$L(A,H)=(A\otimes A)^{co\,H}$}
Todo: urlop.tex \includegraphics{...} -> error which is not seen by ':ShowErrors e' command.
	The error was caused because the graphics file was empty.
Todo: imap <buffer> \8 It is not good to have any imapping starting with '\'.
Todo: [NICE ADDITION] add bracket to completion list (at the end, or at the
	begining if the world before cursor is in completion pool) if there is one to
be closed.
To do: vip: bmove and emove are not 100% accurate \chapter{...}\Xlabel but \chapter{...} X\label will work (X is the place were we move fromm } just before using w normal command.
	This can be solved with moving till first ' ' (white space) or '\' or possibly some other character but before the first '}'.
To do: tag-stack
To do: turn off autoindent in align ... would be OK?

To do:     au BufEnter *.tex.project.vim set nowrap textwidth=0
	(Set this not using filetype plugin)
	One can do that in plugin/atp.vim file - but it might not be worthy to do that just for one setting.

To do: 	$i:\Sub_{\Alg^H}(A)\subseteq\Sub_\Alg(A)^\mathit{op<TAB HERE>$ preserves all
	<Tab> doesn't close {! 

To do: with j motion it can put \mathit{} not just \mathit{.	
To do: TOC when modifiable is set.

To do: NEnv (hit bottom, cont at top) 
To do: Check AMSRef, with xy-ks:galois-theory-of-skew-fields there was no comma after key.  
To do: TabCompletion for \pagestyle command
To do: xcolor package completion

To do: add this error message.
	    (/home/texmf/tex/settings-galois.tex) (./HopfGaloisTheory-field.aux

	    ! Package natbib Error: Bibliography not compatible with author-year citations.

	    (natbib)                Press <return> to continue in numerical citation style.


	    See the natbib package documentation for explanation.
	    Type  H <return>  for immediate help.
	     ...                                              
							      
	    l.144 ...and\NAT@force@numbers{}\NAT@force@numbers

To do: a command/map to switch all the ATP maps on/off :) cool
	DONE FOR IMAPS.
To do: gw when the paragraph is ended on last line of the file (but not on \end{document} (it hapens in input files).

To do: Open should have an option to show full path.

To do: print file in a TOC iff it is in the buffer list. 
       Clear the meaning of t:atp_toc_buflist (it seems that it is not working: the
       files which are not in this list are printed in TOC).

But I think it is better this way, there is vie to match just inside the align (or any other env).
To do: vip is not stopped before \begin{align}:
    is a bijection. In Theorem~\ref{thm:cogalois-extensions} we show that for an
    \(H\)-coextension \(C\sir C^H\) over a ring \(k\) there exists a Galois
    correspondence: 
    \begin{align}\label{eq:prelim-coGalois}
	<HERE vip>\qid(H)\cong\qquot(H)^\mathit{op}\lgalois{K\mapsto C/CK^+}{}\qquot(\nicefrac{C}{C^{H}})^\mathit{op} 
    \end{align}
   
To do: \Labels command: it might be better to put page number instead of line number. 	
To do: UnWrap command.

To do: when changing bib file, the Main File is not processing (atp is not
loaded for bib files!)

To do: \varespilon,... - maps, completion
To do: fix the colors of pdfLaTeX in status (in mygvim it is not working - this might be a local issue).

(A VERY GOOD IDEA): write a package which lists in a file all theorems with numbers that tex is using.
	This can be taken from list of theorems (lot) and list of definitions (lod) files.
	This can be used to have more labels in GotoLabel (tex can print the line number where it is).
	This is implemented in ntheorem.sty.

To do: Suggest to use wdiff to get diff of pdf's with:
	wdiff -w "\textcolor{red}{" -x "}" -y "\textcolor{blue}{" -z "}" file_rev1.tex file_rev2.tex > file_diff.tex
	Or make a function which: removes comment lines, makes diff of
	\begin{document}:\end{document}, lets choose which preambule to use if
	they differ.
	The problematic is making diff of math zones.

Todo: \a has a strange behaviour with respect to tabs. 

To do: The function 'atplib#FindAndOpen' will not start gvim if it is
	not running.
To do: read atp-:SyncXpdf -> port this for Okular.
To do: minimalise the number of options (for example: remove gloabl viewer options)
To do: TOC clicable: <LeftMouse>=like enter <S-LeftMouse>=ForwardSearch
Note: do not set b:atp_okularOptions="--unique" by default. 
To do:
When opening skeleton file -> the g:atp_MathZone is like it was for file type plaintex, but the file type has changed.
The only solution is to set the variable g:tex_flavor="tex"
to do: gm (end math) gM (begin math)
To do: find a better way of dealing with g:atp_latexpackages (update them)
To do: statusNotifHi -> change in to a highliht group name.
To do: xpdfpid() function should be writtine in Python.
To do: rewrite MakeLatex in python (this will help with the screen isue)
To do: SyncTex for (log file --> viewer) can be rewritten to use synctex (usually there is line number of error around -> we can get the position of the pdf file) - but since this is not very useful, this is not urgent.
To do: write python script to parse log file and return list of dictionaries { file : '', line : '', page : '', errormsg : '', errortype : '' )
To do: only in beamer: GotoFrame <frame>: number, title matched by pattern>
To do:(simple and nice) in GotoEnvironemt: (THIS IS NOT POSSIBLE it is a feature of n/N in vim)
	    There is no way to make this searches silent wiht :S and /
	    its better to silently call the functions Search() and search()
To do: for Okular users switch document loaded in okular when changing buffers (handsome).
	for Xpdf it is easy to set: just put b:atp_XpdfServer="tex_files" in atprc.
To do: There are three completion function for environment names: Env_compl (motion.vim, GotoSection, Nenv, ...) and EnvCompletion and EnvCompletionWithoutStarEnvs (various.vim, :WrapEnvironment, :ChangeEnv), F_compl (:F, :B)
	Make them more dependent on LocalEnvironments (to appear only what is defined!)

# To do: check \cite{ completion on startup (from bib file). b:ListOfFiles doesn't contain Mat.bib.
		It might also be %&latex issue -> test 
		THIS IS BECAUSE: skeleton file opens as a tex file and the variables are not reloaded. 

# To do: inner paragraph should be (?) ended with \pause (beamer)
# To do: \{:} are matched as brackets.
# Bug: Labels if label is in comment its line counts (there might be two \label command with the same label but one commented out, it happens that the label in comment counts!, while it should not.
# TEST: progress bar for project files (project variables).
Bad idea (gq is for sth else!): 'formatexpr' (gw -> gq this shoulr be done using format exrpression)
# WOW: the first line: %&latex or %&pdflatex -> tex decides what tool to use! -> ATP should respect this!
# TO DO: using http://python-xlib.sourceforge.net/?page=documentation it should be possible to raise the viewer window after compilation :)
# NOTE: if the latex return code is non zero then reference numbers (Lemma
# X.Y) may be '?'! ( I don't know why its like that )
SyncTex:
	Should test if the viewer is running (this can be done with the help of python and psutils) 
	if not it should run the viewer first.

<Nice Feature> make atprc.vim file in the gentoo style

WINDOWS: Runtime error!
	 Program ...\gvim.exe
	 R6034
	 - An application has made an attempt to load the C runtime library incorrecly.
	 - Please contact the application's support for more information.

bibliograph (python) requirements:
bibliograph-rendering, zope-schema, zope-component

zathura: how to implement inverse searching using bookmarks:
    "https://bbs.archlinux.org/viewtopic.php?pid=807105#p807105"
    this can be done with python script.

ToDo: g:atp_inputfile_pattern : maybe it should be updated by :InputFiles if somebody added/removed biblatex.
ToDo: make ToC work with tabs: find file in another tab and go there (?)
ToDo: The following line is not recognized by TOC: \chapter[Decomposition of values]{Decomposition of Banzhaf and Shapley values}\label{chap:decomposition-of-values}
MakeLatex: There ware undefined references this should be shown in debug mode (THIS BEGIN SPECIAL DEBUG MODE FOR MakeLatex).
ToDo: in insert mode auTeX can wait until compilation stops: when compilers ends it should generate CursorMovedI event if the mode is insert mode - this can be done by a simple function atplib#CursorMoveI(), hmm this is not good, b:atp_PythonPIDs will be not 0
ToDo: MakeLatex on hgt_field.tex (under BZR) pdflatex+bibtex+pdflatex (should do one pdflatex more).
ToDo: Status line for QuickFix Window.
ToDo: ChangeEnv \(:\) => \begin{equation}:\end{equation}
ToDo: CTOC doesn't change when I change the title. Only after running TOC!
ToDo: gw on \end{proposition} joints this line with the next one.

Look at: bibweb
Note: { \{ <Tab>  \} => { \{ \}  \}

To do: 
    \begin{e1}
	\begin{e2}
	... 'vae'
	\end{e2}
    \end{e1}
    Then move to end of e1 and type agina 'ae', it will contain only e2, unlike going to the end of e2 and 'vae'.
    This is a problem with getpos(".") in visual mode in LatexBox_GetCurrentEnvironment.
    See comments in LatexBox_GetCurrentEnvironment.

Bug: atplib#CloseLastEnvironment() if invoked without arguments: the variable l:begin_line_env in line 193 is not defined.

ToDo: atplib#CloseLastEnvironment() should not move cursor when closing \begin:\end pairs - then one can use <C-M to open new line.

ToDo: atplib#CloseLastBracket() add some options: bracket pattern, etc ... for algorithmic envs.

ToDo: Find how to make it possible to run :copen 5 (w:quickfix_title will not work)
	Test this feature if it changes size of qf window (callback, etc...)
	At least this is doc.
ToDo: when working with two tex files and opened QuickFix window, :copen changes the errorfile, it ATP should change b:atp_ErrorFormat to the ErrorFormat of corresponding buffer.
this is not working:
"     au FileType qf :call <SID>SetErrorFormat(getbufvar(bufnr(fnamemodify(&l:errorfile, ":r").".tex"),"atp_ErrorFormat"),1)
two files and one QFList, set efm, change it and ...

New Feature: add dictionary of J.Trzeciak: http://www.impan.pl/cgi-bin/dictsearch?q=<SEARCH_KEYWORD>
	I even can add completion as there are web pages with words starting with each letter, for example for m:
	    http://www.impan.pl/Dictionary/m.html

Bug: progress bar starts at [5] :MakeLatex /probably because UnicodeDecodeError/
add note to doc.

NOTE: from vim_dev CursorHoldRepeat and CursorHoldRepeatI are on the way (I needed them somewhere).

Delete! could also delete all files under b:atp_TempDir and g:atp_TempDir (but not the directories, which are removed when vim exists).

Bug: The problem with TOC window is that it is the same buffer for different tabs, if one changes it in one tab it changes in the other one. This should be FIXED. I can use tabpagenr()

Example from doc how to define maps in filetype plugins:
I should follow the hasmapto step for every map!

	" Add mappings, unless the user didn't want this.
	if !exists("no_plugin_maps") && !exists("no_mail_maps")
	  " Quote text by inserting "> "
	  if !hasmapto('<Plug>MailQuote')
	    vmap <buffer> <LocalLeader>q <Plug>MailQuote
	    nmap <buffer> <LocalLeader>q <Plug>MailQuote
	  endif
	  vnoremap <buffer> <Plug>MailQuote :s/^/> /<CR>
	  nnoremap <buffer> <Plug>MailQuote :.,$s/^/> /<CR>
	endif

Viewer command (map) might say: [ATP:] openning ... some times it takes a second or two, this will make the time past faster ;)

ToDo: do what hier plugin does (but not for tex files) highlight what is in quick fix window in the buffer (correct).
ToDo: vip is matching \label and \hypertarget
ToDo: I make vip to stop on \begin:\end but this is 

ToDo: vip stops before \begin and before \[ but not before \begin{equation}, is this the right way?
	vip stops one left to much before a \\
Todo: << in visual mode is working not as should.
Todo: sort completion for Labels according to line number (and files).

Bug: :Labels with :TOC

ToDo: not copying aux file when there are errors is some times not nice. Maybe we can copy it to aux1 and use it or store it in memory.

IDEA: from vim_use: conceal comments:
http://www.vim.org/scripts/script.php?script_id=3583

ToDo: Recover plugin which I use breaks auTeX.

ToDo: b:atp_updatetime_insert, b:atp_updatetime_normal should be buffer local. Maybe for long files they should have different setting.

Bug: Error while opening plain tex files (%&tex)

Bug: comments vim option is not working well with [d. Check [i, :dsearch, :isearch are not finding anything. 

ToDo: latextags.py could respect tagrelative (this might be important for project in version control systems..

:) : see :help :ownsyntax

ToDo: latextags.py finds \label inside \def statements! (but this way it is faster)
ToDo: add options to making tags: append tags (note that tags should be sorted)
	( in this way one can have one tag file for many files, this might be nice if one edits two ore more files )
ToDo: see atp-:NiceDiff  -- I said that I will try to do sth :)

ToDo: rewrite :S in python 		-> this will be as fast as :ijump.
ToDo: look into LocalCommands for patterns which might be used in make_defi_dict
ToDo: InputFiles when called from different directory.
ToDo: :BibSearch -- when there is (STRING) the last ) is lost and syntax fails. Track this.
ToDo: There is quite big mess when callig gf (how files are listed)

ToDo: opening skeletal file: b:ListOfFiles is empty => b:atp_LocalCommands is empty.
ToDo: \todo[inline]{ todo keywords are completing here, they shoud not, I think}
ToDo: \partial \overline \overline{
ToDo: python compiler should make g:atp_TempDir if it doesn't exists (I deleted it and there was an error).
ToDo: test b:atp_updatetime_ variables when they are set to 0, test &l:updatetime setting in options.vim (line 920).
ToDo:   Tikz Completion for -> <-, etc. : no its too short!
ToDo:	Make better accent maps which takes the letter as an argument and returns accented one.
	`"a -> \"{a} it would be nice to make it without asking in the command line maybe using ? 
ToDo:   How to solve the problem \{:\. (it seems to be not solved) or mayby I just don't remember how to do that in LaTeX.
ToDo:   \wedge map #& should be defined with a space after wedge, and some other maps as well \partial (`6)
	Maybe make an option with list of commands to which TabCompletion will append a space.
    (I had problem implementing this as a configurable feature)
ToDo: (IDEA) make C_M inside align inteligent ( put & if first column is empty ) 
ToDo:  inside tikzpicture \beg<Tab>, \begin{slo<Tab> are not working! node[...]{\(d<Tab> => ) should \)
	in my test file it works...
	only \begin{scope}<Tab> will not close environment since keywords are 'flying' around ;).
ToDo:  gw mis behaves when it is near \todo{}
ToDo:  #ve -> \vee colides with #v -> \vartheta (imaps)
	#Z -> \mathrm ?
ToDo:  YankSection, DeleteSection, should not yank sections which are commeted out.
ToDo:  put all the leader variables in doc (g:atp_infty_leader might not be documented -- check this).
ToDo:  add \forall \exists maps - I don't know the right keays to use: <C-a> and <C-m>?
ToDo:  recover.vim plugin fails with my settings when openinig a file from other directory than its base directory!
ToDo:  HelpIMathIMaps add all math imaps, make it like ShowOptions, allow for patterns.
	Maybe make a HelpMap command to search for a map - just one command.
	:HelpMap [pattern] [mode]
ToDo:  Why texMathZoneT (tikz) is in g:atp_MathZones (atplib#IsInMath() function,
       it can filter it if invoked with bang atplib#IsInMath("!").  If because
       of \matrix[matrix of math nodes, it can be matched sepretaly] (this
       will be slower, but first we can check if we are in tikzpicture and
       where it starts/ends
ToDo:  closing \(:\) when \(\s*$ and cursor is in the same line close this env in the same line not next one!
ToDo:  I think my changes are such that one cannot turn off 'tikzpicture
	keywords' from completion - this should be ended and tested ...
ToDo:  TOC with two files one beamer (press <Enter> on beamer document)
ToDo:  \\[2em<Tab> \\[2em\]!
ToDo:  why sometimes progress bar starts at [5] or sth like that.
ToDo:  vae commented evironment inside another environment will match the
       outer one: do we want that, note that the inner, commented one can be
       marked with _c.
ToDo:  biber log messages /I didn't get a replay from biblatex mailing list/
ToDo:  Why :InputFiles works so slow in seminar.tex (Almeria)
ToDo:  webpage rssreader (see the 9.6.7 message in it and in news - what is
	after <CR> is not showing up - check what is in the xml file.
ToDo:  make >e, >E, >f, >F maps work in vmode (but it might not make much sense)
ToDo:  search for commands (LocalCommands), inside packages which are installed
	under local texmf or which are in the current directory
	/this feature should be optional/
ToDo:  :Wrap \begin{proof} \end{proof} 1 1 around another evnironment.
ToDo:  vie \centerline{...} the end should stop the line. \\ is not well recognized.
ToDo:  TOC should work in a different way in beamer class - should search for
	frame environment, and inside it search for a title.
ToDo:  s:maketoc join lines if title is spanned in more than one line.
ToDo:  add g:atp_package_..._environments to abbreviations
	add completion for command options:
	g:atp_package_PNAME_command_CNAME_options
ToDo:  \mulitcolumn of longtable might need more than one latex run --> look at log file for a message!
ToDo: in options.vim where package files are loaded:
    " We cannot restrict here to not source some files - because the completion
    " variables might be needed later. I need to find another way of using this files
    " as additional scripts running syntax ... commands for example only if the
    " packages are defined.
ToDo: add good log info for TabCompletion: commands values, etc ... and instruct users how to use it.
ToDo: \thref in ntheorem.sty page 11 - LaTeX needs to be run twice.
ToDo: amsthm is loaded by ntheorem with option amsmath
NEW FEATURE: DICTIONARY!!!

# IMPORTANT ToDo:  :ShowErrors actully the error format: only first message contains detailed info about the error.

Done: there is no imap for \times.
Bug: \begin{equation}<Tab>\end{equation}closing equation ... (this text should not be added to the inserted stuff)
ToDo: w b are not stopping at \
	iskeyword is set somewhere after my options.vim script.
Done: look at the note befor atplib#CheckBracket -> this might speed up closing brackets in atplib#TabCompletion.
Done: Thinks if not restore the tikzpicture keyword completion mode.
	I forgot that it is working but only in non expert mode!
Done: <S-Tab> when closing brackets: put the cursor before the bracket, environment (leave the cursor where it was :)
	This is done but only for closing brackets, not for closing \(:\), ... and envs.
NOTE: b:atp_ProgressBar if is nonempty, the number start not from 1 (this was after using the :Kill command).
Note: \refstepcounter is not handled well by syntax.vim \ref has syntax group texRefZone, while stepcounter not.
Done: after :ReloadATP ]i, ]I and ]ite are  mixed, probably a problem with g:atp_imap_ShortEnvIMaps 
	solution: entirely removed g:atp_imap_reload_variables
Done: atplib#CheckBracket line 365 of hgt.tex:
		\end{array}\right\}\label{eq:oz-1}\hypertarget{eq:oz-1}{<Tab> (is not closing!)
		counting brackets might not always work! we should always stop counting on openning bracket.
ToDo:  diacrtics maps could be defined only after certain letters - and the letters might be given in a variable.
ToDo:  ++ map could work only if _ or ^ are not just before, unless there are \^ or \_
Done:  vmap _ov and imap 'o to \overline 
		(_ov should be 'o aswell)
NOTE:  \({\lfoor X\rfloor<Tab> -- will close as should but also saves the file, why?
	This is because atplib#LocalCommands is run python version saves the file, why vim version is not - doesn't need to - operate on the buffers!
Done: Closing Brackets:
    \[M\otimes_R(\bigcap_{\alpha\in I}N_\alpha)\eir \im(M\otimes_R(\bigcap_{\alpha\in I}N_\alpha)<TAB>\ir \bigcap_{\alpha\in I}\im(M\otimes_R N_\alpha)\] 
Done: ( (   <TAB> ) will not close ) as it seems to be closed but ( (  ) <TAB> will do!
ToDo: $:$ are closed when they are closed.
Done: TabCompletion: tikz keywords are closing ] also.
ToDo: \begin{env}\label{LABEL}\hypertarget{LABEL}{} aaa vip \end{env}
	in normal mode is highlighting \hyperref command while it should not.
ToDo: \cite completion shows ligatures like Gr"atzer.
Check: the last tab completions    "{{{3 --------- brackets, algorithmic, abbreviations, close environments
ToDo: abbreviations should complete before brackets
ToDo: add to doc: tab completion for abbreviations works only when ending with <space> and not <c-y>.
	It also doesn't work just after { and (, i.e {=theorem=<space> will not
	work, but this is the case for abbreviations, it is not related to tab
	completion.
