#
# Author: Marcin Szamotulski
# This is a to do list for ATP vim plugin.
# I put here notes on planned features, 
# but mainly I use this file for bugs that I found.

pedit for openning without changing the window number! 

Make defisearch use location list (in more vim style).
		(This was imposible for some reason)

ToDo: GotoNextSection --> GoTo 3rd section :) using count!
SOLUTION: I can use the "= register (see map-examples)

ToDo: completion of user defined command \mpr{} (with {}) position the cursor
in the right place)

ToDo: add support for plain TeX users in the function atplib#SearchPackage()
	in TeX one writes: '\input tikz.tex' instead of '\usepackage{tikz}'
	in while in ConTeXt '\usemodule[tikz]'

ToDo: Pattern not found should restore the window position
ToDo: :2match (and :3match)  in HighlightMatchingPair and Search function - it
is better to use matchadd().

ToDo: Disable mapping # before \ (make an IMAP function)
Bug: \ref{2.\d<Tab> will try to complete label instead of passing a regexp to
label completion.
Doc: updatetime setting in insert mode 
Bug: syntax groups for status don't work in vim 7.3d (in common.vim)

    "THIS MIGHT BE USEFULL:
    The first column is 1.	0 is returned for an error.
    A more advanced example that echoes the maximum length of
    all lines:
    echo max(map(range(1, line('$')), "virtcol([v:val, '$'])"))

MakeLatex	    
	MakeLatex, Delete -> puts MakeLatex in an endless loop.

TODO: make toc work with parts!
 		The work has started ...

TODO: Check against lilypond 

Todo: make small Help functions with list of most important mappings and
commands for each window (this can help at the begining) make it possible to
turn it off.

<Ctrl-W>k<Ctrl-W>_		Fast switching bettween buffers				

To do: MakeLatex add support for loa (list of algorithms). 

<HARD>
Make a function which reads the log file and sets error list.	
It is quite hard to make efm so that it gets error messages with file name.
Possible solution is to write w program/function to rewrite the log message.

In 'plaintex' MakeLatex results in an infinte loop. 

:S /{pattern}/ is not working in plain tex files.

<NICE FEATURE> \v with counter: runs that many copies of viewer.
	probably not needed.
	/needed only for xpdf/

<Nice Feature> YankSection -> in toc (there is delete section so yank
shuoldn't be dificult).

Bug: \ref{<Tab> and the screen is redrawn (like redraw!)
<Nice Feature> if none of completions is working use tab as a normal Tab key.
/this will be slow/
<Nice Feature> make atprc.vim file in the gentoo style
Bug: \{ ... <Tab> =? \{ ... } 	( generically it works )
To do: add large delimiters to completion (Bracket closings: Table 3.9 in
    lshort pdfpage: 80) but also \lceil:\rceil, \lfloor:\rfloor, \vert:\vert,
    \Vert:\Vert (make this fast, count all $,\vert,\Vert at once)
To do: completion: make the screen stable.

To do: Make an if statement: write if the history is nonempty!
?To do: \left\.:\right pair! (let the user write the closing bracket.
	also \lvert:\rvert, \lVert:\rVert (only in amsmath)

Bug: How to make NextSection and PreviousSection work with omap.

Done: <NICE FEATURE> GotoLabel {labelname or label number}
	(this is done with :Labels, but it might be a good idea to have
	a command for that - with a nice completion) 

To do? +- -> \pm +| -> \dagger ++ -> \ddagger  
Partialy Solved: imap #8 is mapping to <F8> !
To do: \cite by number.
To do: Show History (at least the variables which are short)
 
To do: Make Todo for project files.

To doc: compare double empty lines, compare spaces.
To do: test SyncXpdf when syncing the last page (boarder conditions).
	It doesn't work as it should - this is a minor bug.

NOTE: in aux file definitions are resolved (see \av)

To do: <NEW FEATURE> \c which adds % before \begin and \end (if the line contains \begin)

To do: :R Replace like :S  (project files). /there might be vim way to do that/.

Bug:  BibSearch /Brzeznski/ shows articles of Pflaum! (Mat.bib).
Because he is in:
    MRCLASS   
    MRNUMBER  
    MRREVIEWER
The problem is that All flag doesn't show this entries.  


Todo: Write searchpair function for log file which ignores bracketes in
Overfull message (it happens that these brackets doesn't come in pairs!).

Todo: SetProjectName should test project scripts, I think LoadProject has this code!
	There are two function to implement this: FindProjectScripts() and GetProjectScript()
 
Todo: :S could be faster using ijump.
Todo: TexSyntaxMotion is not working on last H of: \mbox{$L(A,H)=(A\otimes A)^{co\,H}$}
Todo: urlop.tex \includegraphics{...} -> error which is not seen by ':ShowErrors e' command.
	The error was caused because the graphics file was empty.
Todo: imap <buffer> \8 It is not good to have any imapping starting with '\'.
Todo: [NICE ADDITION] add bracket to completion list (at the end, or at the
	begining if the world before cursor is in completion pool) if there is one to
be closed.
To do: vip: bmove and emove are not 100% accurate \chapter{...}\Xlabel but \chapter{...} X\label will work (X is the place were we move fromm } just before using w normal command.
	This can be solved with moving till first ' ' (white space) or '\' or possibly some other character but before the first '}'.
To do: tag-stack
To do: turn off autoindent in align ... would be OK?

To do:     au BufEnter *.tex.project.vim set nowrap textwidth=0
	(Set this not using filetype plugin)
	One can do that in plugin/atp.vim file - but it might not be worthy to do that just for one setting.

To do: 	$i:\Sub_{\Alg^H}(A)\subseteq\Sub_\Alg(A)^\mathit{op<TAB HERE>$ preserves all
	<Tab> doesn't close {! 

To do: with j motion it can put \mathit{} not just \mathit{.	
To do: TOC when modifiable is set.
#
To do: NEnv (hit bottom, cont at top) 
To do: Check AMSRef, with xy-ks:galois-theory-of-skew-fields there was no comma after key.  
To do: TabCompletion for \pagestyle command
To do: xcolor package completion

To do: add this error message.
	    (/home/texmf/tex/settings-galois.tex) (./HopfGaloisTheory-field.aux

	    ! Package natbib Error: Bibliography not compatible with author-year citations.

	    (natbib)                Press <return> to continue in numerical citation style.


	    See the natbib package documentation for explanation.
	    Type  H <return>  for immediate help.
	     ...                                              
							      
	    l.144 ...and\NAT@force@numbers{}\NAT@force@numbers

To do: a command/map to switch all the ATP maps on/off :) cool
To do: gw when the paragraph is ended on last line of the file (but not on \end{document} (it hapens in input files).

To do: Open should have an option to show full path.

To do: print file in a TOC iff it is in the buffer list. 
       Clear the meaning of t:buflist (it seems that it is not working: the
       files which are not in this list are printed in TOC).

But I think it is better this way, there is vie to match just inside the align (or any other env).
To do: vip is not stopped before \begin{align}:
    is a bijection. In Theorem~\ref{thm:cogalois-extensions} we show that for an
    \(H\)-coextension \(C\sir C^H\) over a ring \(k\) there exists a Galois
    correspondence: 
    \begin{align}\label{eq:prelim-coGalois}
	<HERE vip>\qid(H)\cong\qquot(H)^\mathit{op}\lgalois{K\mapsto C/CK^+}{}\qquot(\nicefrac{C}{C^{H}})^\mathit{op} 
    \end{align}
   
To do: \Labels command: it might be better to put page number instead of line number. 	
To do: UnWrap command.

To do: when changing bib file, the Main File is not processing (atp is not
loaded for bib files!)

Done: \DeclaraMathOperator for :LocalCommands
Done: ShowErrors o <- add to command completion.
To do: \varespilon,... - maps, completion
To do: fix the colors of pdfLaTeX in status (in mygvim it is not working - this might be a local issue).
(A VERY GOOD IDEA): write a package which lists in a file all theorems with numbers that tex is using.
	This can be taken from list of theorems (lot) and list of definitions (lod) files.
	This can be used to have more labels in GotoLabel (tex can print the line number where it is).
	This is implemented in ntheorem.sty.

To do: Closing environment inside environment at a wrong line. It is maybe
	better to close enumerate where the user asks. 

To do: check wdiff to make diff for tex files.
To do: Suggest to use wdiff to get diff of pdf's with:
	wdiff -w "\textcolor{red}{" -x "}" -y "\textcolor{blue}{" -z "}" file_rev1.tex file_rev2.tex > file_diff.tex
	Or make a function which: removes comment lines, makes diff of \begin{document}:\end{document}, lets choose which preambule to use if they differ.
	The problematic is making diff of math zones.

Two things:
(1) SyncTeX: Can't rename HopfGaloisTheory-field.synctex.gz(busy) to /tmp/v27Wp1j/34/HopfGaloisTheory-field.synctex.gz
bytes).
	Possible solution copy tex file to the tmp directory, operate there on the copy 
	(but this is not a good solution for project files).
	This error is only within vim, not from the command line. 
(2) /bin/cp  how to make that it is not asking if to copy files. Is there a bash variable for that?
	Set cp command on startup (with variable). 

Todo: \a has a strange behaviour with respect to tabs. 

To do: The function 'atplib#FindAndOpen' will not start gvim if it is
	not running.
To do: read atp-:SyncXpdf -> port this for Okular.
To do: minimalise the number of options (for example: remove gloabl viewer options)
To do: TOC clicable: <LeftMouse>=like enter <S-LeftMouse>=ForwardSearch
Note: do not set b:atp_okularOptions="--unique" by default. 
To do:
When opening skeleton file -> the g:atp_MathZone is like it was for file type plaintex, but the file type has changed.
The only solution is to set the variable g:tex_flavor="tex"
To do: node{\(...\)<tab>
to do: gm (end math) gM (begin math)
To do: debug ]d
To do: test debug mode.
To do: find a better way of dealing with g:atp_latexpackages (update them)
To do: statusNotifHi -> change in to a highliht group name.
To do: xpdfpid() function should be writtine in Python.
To do: rewrite MakeLatex in python (this will help with the screen isue)
To do: SyncTex for (log file --> viewer) can be rewritten to use synctex (usually there is line number of error around -> we can get the position of the pdf file) - but since this is not very useful, this is not urgent.
To do: write python script to parse log file and return list of dictionaries { file : '', line : '', page : '', errormsg : '', errortype : '' )
Check: check from time to time if atp_RevSearch.py (/tmp/atp_RevSearch.py) in output has byte strings ( b'...'\n ) maybe I do not need matching them (now they disapeard!, Ivo Lopez is reporting that he doesn't have them.).
To do: write completion for \includegraphics{}
Done: TabComp input files \include{...} \com<Tab> -> comp_method=inputfiles (one cannot complete commands).
Fixed: Open every time sth changes I have to use Open! it is strange!
	I think WriteProjectScript global is not saving the variable.
(?)To do: map t :SyncTex is not working 
To do: only in beamer: GotoFrame <frame: number, title matched by pattern>
To do:(simple and nice) in GotoEnvironemt: (THIS IS NOT POSSIBLE it is a feature of n/N in vim)
	    There is no way to make this searches silent wiht :S and /
	    its better to silently call the functions Search() and search()
To do: for Okular users switch document loaded in okular when changing buffers (handsome).
	for Xpdf it is easy to set: just put b:atp_XpdfServer="tex_files" in atprc.
Done!: add :WrapEnvironment <env_name> command. (this will be mapped to <F4> and <F4> will be remapped to <S-F4> and <S-F4> will not be mapped).
To do: ShowErrors w when there are no warnings should say no warnings :)
To do: There are three completion function for environment names: Env_compl (motion.vim, GotoSection, Nenv, ...) and EnvCompletion and EnvCompletionWithoutStarEnvs (various.vim, :WrapEnvironment, :ChangeEnv), F_compl (:F, :B)
	Make them more dependent on LocalEnvironments (to appear only what is defined!)
To do: MakeLatex is not WINDOWS COMPATIBLE (because it uses bash syntax, I need python code to execute commands)
	If MakeLatex would be done in Python -> progress bar could be made.
	(at least it can call Python compiler)
To do: check \cite{ completion on startup (from bib file). b:ListOfFiles doesn't contain Mat.bib.
		It might also be %&latex issue -> test 
		THIS IS BECAUSE: skeleton file opens as a tex file and the variables are not reloaded. 
# To do: inner paragraph should be (?) ended with \pause (beamer)
# To do: \{:} are matched as brackets.
Done: :YankSection (like :DeleteSection in ToC)
# Bug: Labels if label is in comment its line counts (there might be two \label command with the same label but one commented out, it happens that the label in comment counts!, while it should not.
# To do: :WrapSelection make better interface.
To do: debug why sometimes generating g:atp_latexpackages takes so much time.
Done: make a default flag for :ShowErrors 
# TEST: progress bar for project files (project variables).
To do: bash compiler is not reloading Xpdf.
To do: [MakeLatex] if bibtex (makeindex) has errors -> exclude the conditions on bibtex (makeindex)
	Debug: MakeLatex. (implemented in compile.py)
To do: 'formatexpr'
# Done: Bibtex when bibtex returns errors should not stop but in silent mode: just say what was the return code of bibtex in debug mode print bibtex output.
# WOW: the first line: %&latex or %&pdflatex -> tex decides what tool to use! -> ATP should respect this!
Done: GotoLabel gives one label to choose from (it should take this one and go :).
# TO DO: using http://python-xlib.sourceforge.net/?page=documentation it should be possible to raise the viewer window after compilation :)
# NOTE: if the latex return code is non zero then reference numbers (Lemma
# X.Y) may be '?'! ( I don't why its like that )
# Done: Xpdf sleep time between sending remote commands (SyncTex)
SOLUTION FOR CallBack: get all messages into list [ [ msg_text : highlight group ], ... ] and echo them at the end. 
	g:atp_DefualtDebugMode == "silent" && !errors -> cclose
	t:atp_DebugMode == "silent" || a:mode == "silent" -> cclose
	(t:atp_DebugMode == "debug" || a:mode == "debug") && errors && !t:atp_QuickFixOpen -> clist
	What for to show in debug mode what was the error code of latex if quickfix window is opened ...
SyncTex:
	Should test if the viewer is running (this can be done with the help of python and psutils) 
	if not it should run the viewer first.

Done: atplib#CallBack() is not working with bash compiler (it is important for IST to have it - there is python but vim is not supporting it. b:atp_TexReturnCode doesn't exists. See also log.vim in IST. (Python_rmdir cannot be called) 
